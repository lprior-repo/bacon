{
  "DiscoverResourcesWithExplorer": {
    "Type": "Task",
    "Comment": "Use Resource Explorer to discover resources efficiently",
    "Resource": "arn:aws:states:::aws-sdk:resourceExplorer2:search",
    "QueryLanguage": "JSONata",
    "Arguments": {
      "QueryString": "{% 'resourcetype:' & $states.input.resourceType %}",
      "ViewArn": "{% $states.input.resourceExplorerViewArn %}",
      "MaxResults": 1000
    },
    "Output": "{% $merge([$states.input, {'discoveredResources': $states.result.Resources, 'nextToken': $states.result.NextToken}]) %}",
    "Catch": [
      {
        "ErrorEquals": ["States.ALL"],
        "Output": "{% $merge([$states.input, {'explorerError': $states.errorOutput, 'discoveredResources': []}]) %}",
        "Next": "${ERROR_HANDLER_STATE}"
      }
    ],
    "Next": "CheckForMoreResources"
  },
  "CheckForMoreResources": {
    "Type": "Choice",
    "Comment": "Check if there are more resources to retrieve with pagination",
    "QueryLanguage": "JSONata",
    "Choices": [
      {
        "Condition": "{% $exists($states.input.nextToken) %}",
        "Next": "FetchMoreResources"
      }
    ],
    "Default": "${NEXT_PROCESSING_STATE}"
  },
  "FetchMoreResources": {
    "Type": "Task",
    "Comment": "Continue fetching resources using pagination token",
    "Resource": "arn:aws:states:::aws-sdk:resourceExplorer2:search",
    "QueryLanguage": "JSONata",
    "Arguments": {
      "QueryString": "{% 'resourcetype:' & $states.input.resourceType %}",
      "ViewArn": "{% $states.input.resourceExplorerViewArn %}",
      "MaxResults": 1000,
      "NextToken": "{% $states.input.nextToken %}"
    },
    "Output": "{% $merge([$states.input, {'discoveredResources': $append($states.input.discoveredResources, $states.result.Resources), 'nextToken': $states.result.NextToken}]) %}",
    "Next": "CheckForMoreResources"
  }
}